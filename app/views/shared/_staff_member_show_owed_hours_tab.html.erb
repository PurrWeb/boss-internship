<h2> Owed Hours</h2>

<div class="panel panel-default">
  <div class="panel-heading">
    <span>Add Hours</span>
  </div>
  <div class="panel-body">
    <%= render partial: 'shared/add_owed_hour_form', locals: { staff_member: staff_member, owed_hour_form: owed_hour_form } %>
  </div>
</div>

<% owed_hours = OwedHour.enabled.where(staff_member: staff_member).all %>
<% if owed_hours.present? %>
  <% owed_hours_by_week = owed_hours.group_by { |owed_hour| RotaWeek.new(owed_hour.week_start_date)  }.sort_by { |week, hours| week } %>
  <% owed_hours_by_week.each do |week, hours| %>
    <p><strong>Mon <%= week.start_date %> - Sun <%= week.end_date %></strong></p>
    <% total_minutes = hours.inject(0) { |sum, hours| sum + hours.minutes } %>
    <p>Total: <%= HoursHelper.new(total_minutes: total_minutes).description %> </p>
    <table class="table">
      <thead>
        <tr>
          <th>Duration (Hours)</th>
          <th>Duration (Minutes)</th>
          <th>Created By</th>
          <th>Note</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% hours.each do |owed_hour| %>
          <% hours_helper = HoursHelper.new(total_minutes: owed_hour.minutes) %>
          <tr>
            <td><%= hours_helper.hours %></td>
            <td><%= hours_helper.minutes %></td>
            <td><%= owed_hour.creator.full_name %> on <%= owed_hour.created_at.to_s(:human_date) %></td>
            <td><p><%= owed_hour.note %></p></td>
            <td>
              <% if owed_hour.editable? %>
                <div class="boss-page-content_adjust_columns-buttons-group">
                    <%= link_to('Edit', edit_owed_hour_path(owed_hour), class: 'boss-button boss-button_role_edit boss-page-content_adjust_button') %>
                    <%= link_to(
                          staff_member_owed_hour_path(
                            staff_member_id: staff_member.id,
                            id: owed_hour.id
                          ),
                          method: :delete,
                          class: 'boss-button boss-button_role_delete boss-page-content_adjust_button'
                        ) do %>
                      Delete
                    <% end %>
                </div>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    <table>
  <% end %>
<% else %>
  <div>No Owed Hours</div>
<% end %>
